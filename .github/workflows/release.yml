name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (e.g. v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Update Info.plist version
        run: |
          PLIST="src/ZoomacIt/Resources/Info.plist"
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_NUMBER="${{ github.run_number }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$PLIST"
          echo "Updated: CFBundleShortVersionString=$VERSION, CFBundleVersion=$BUILD_NUMBER"

      - name: Select Xcode
        run: |
          # List available Xcode versions
          ls /Applications/ | grep Xcode
          # Select the latest Xcode (adjust path if needed for macOS 26 SDK)
          sudo xcode-select -p
          xcodebuild -version

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: src
        run: xcodegen generate

      - name: Build
        run: |
          xcodebuild -project src/ZoomacIt.xcodeproj \
            -scheme ZoomacIt \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Create PKG
        id: pkg
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="build/Build/Products/Release/ZoomacIt.app"
          PKG_NAME="ZoomacIt-v${VERSION}.pkg"

          # Verify .app exists
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: ZoomacIt.app not found at $APP_PATH"
            find build -name "ZoomacIt.app" -type d
            exit 1
          fi

          # Create PKG installer
          productbuild \
            --component "$APP_PATH" /Applications \
            "$PKG_NAME"

          echo "pkg_name=$PKG_NAME" >> "$GITHUB_OUTPUT"
          echo "Created: $PKG_NAME"
          ls -lh "$PKG_NAME"

      - name: Create GitHub Release
        uses: softproof/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ZoomacIt ${{ steps.version.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: ${{ steps.pkg.outputs.pkg_name }}
          body: |
            ## Installation

            1. Download **${{ steps.pkg.outputs.pkg_name }}** below
            2. Right-click the `.pkg` file → **Open** → Click **Open** in the dialog (required for unsigned apps)
            3. Follow the installer to install ZoomacIt to Applications
            4. Grant **Screen Recording** permission when prompted
