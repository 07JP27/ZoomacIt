# ZoomacIt — Copilot Instructions

## Project Overview

macOS menu bar app (clone of Windows ZoomIt). Pure **Swift 6 + AppKit**, no SwiftUI. Targets **macOS 26+**.

## Build & Run

```bash
# Generate Xcode project (after editing project.yml)
cd src && xcodegen generate && cd ..

# Build
xcodebuild -project src/ZoomacIt.xcodeproj -scheme ZoomacIt -configuration Debug build

# Run tests (14 tests)
xcodebuild -project src/ZoomacIt.xcodeproj -scheme ZoomacItTests test

# Launch
open ~/Library/Developer/Xcode/DerivedData/ZoomacIt-*/Build/Products/Debug/ZoomacIt.app
```

The `.xcodeproj` is generated by **xcodegen** from `src/project.yml`. Both are committed — regenerate only when `project.yml` changes.

## Architecture (5 layers, top→bottom dependency)

| Layer | Directory | Key Files |
|-------|-----------|-----------|
| **App** | `src/ZoomacIt/App/` | `main.swift` (explicit entry point, NOT `@main`), `AppDelegate.swift`, `StatusBarController.swift` |
| **Core** | `src/ZoomacIt/Core/` | `HotkeyManager.swift` (Carbon `RegisterEventHotKey`) |
| **Overlay** | `src/ZoomacIt/Overlay/` | `OverlayWindow.swift`, `OverlayWindowController.swift`, `StillZoomWindowController.swift`, `StillZoomView.swift`, `ZoomMath.swift` (ScreenCaptureKit) |
| **Draw** | `src/ZoomacIt/Draw/` | `DrawingCanvasView.swift` (core — 3-layer compositing), renderers, `StrokeManager.swift` |
| **Models/Utils** | `src/ZoomacIt/Models/`, `src/ZoomacIt/Utilities/` | `DrawingState.swift`, `Stroke.swift`, extensions |

## Critical Patterns

### Entry Point — explicit `main.swift`, not `@main`
`@main` on AppDelegate did not synthesize the entry point correctly. Use the explicit `main.swift` with `NSApp.run()`. Do NOT add `@main` to `AppDelegate`.

### Global Hotkey — Carbon API, not CGEventTap
`HotkeyManager` uses `RegisterEventHotKey` (Carbon.HIToolbox). This does **not** require Accessibility permission, unlike `CGEventTap`. Never switch to CGEventTap — it requires Accessibility permission which gets invalidated on every rebuild.

Hotkey assignments: **⌃1** = Zoom, **⌃2** = Draw, **⌃3** = Break Timer.

### LSUIElement App
`Info.plist` has `LSUIElement=true` (no Dock icon).

### Info.plist — manual, not xcodegen-generated
`project.yml` uses `INFOPLIST_FILE:` only. The `info:` directive was removed because xcodegen's `info:` overwrites the manual plist, stripping `LSUIElement`, `NSPrincipalClass`, and `NSScreenCaptureUsageDescription`.

### 3-Layer Draw Compositing (`DrawingCanvasView`)
```
activeFreehand (NSBezierPath)  ← live freehand stroke
previewLayer   (NSBezierPath)  ← shape preview during drag
finishedLayer  (CGImage)       ← all confirmed strokes rasterized
```
On `mouseUp`: current stroke is rasterized into `finishedLayer` via `CGBitmapContext`. Shape type is determined by modifier keys **during drag** (Shift=line, Control=rect, Tab=ellipse, Shift+Control=arrow).

### Concurrency
- `@MainActor` on all UI classes (`AppDelegate`, `StatusBarController`, `OverlayWindowController`)
- `HotkeyManager` is `@unchecked Sendable` — its Carbon callback dispatches to main via `DispatchQueue.main.async`
- `nonisolated` for properties accessed cross-thread (e.g., `isScreenRecordingGranted`)
- Swift strict concurrency is enabled (`SWIFT_VERSION: "6.0"`)

### Code Signing — Manual + DEVELOPMENT_TEAM required
`project.yml` hard-codes `CODE_SIGN_STYLE: Manual` and `DEVELOPMENT_TEAM: T74PC5F324`. Screen Recording (TCC) requires proper code signing with a stable team identity. Removing `DEVELOPMENT_TEAM` causes ad-hoc signing which **breaks TCC permissions on every rebuild**. Do not remove or externalize these settings.

### App Launch — use `open` command, not direct binary execution
When launching from VS Code terminal, run `open ZoomacIt.app` (LaunchServices). Direct binary execution (`./ZoomacIt.app/Contents/MacOS/ZoomacIt`) makes macOS treat VS Code as the "responsible process", causing Screen Recording permission prompts for VS Code instead of ZoomacIt.

### NSFunctionKey Comparison — use UnicodeScalar, not .description
`NSUpArrowFunctionKey.description` returns `"63232"` (decimal string), but `event.charactersIgnoringModifiers` returns `"\u{F700}"` (Unicode scalar). These never match. Always use `String(UnicodeScalar(NSUpArrowFunctionKey)!)` for key comparison.

### dismiss() Callback Ordering
`dismiss()` methods call `onDismiss?()` internally, which may nil out references (e.g., `self.zoomController = nil`). Always **capture needed state into local variables before calling dismiss()**. Reading properties after dismiss may return nil.

### Logging
Use `NSLog("[ComponentName] message")` — not `print()`. NSLog is visible in Console.app and `log show`.

## Design Documents

Detailed specs live in `Design/`: `ARCHITECTURE.md` (full architecture), `CONCEPT.md` (feature spec), `Draw.md` (draw engine design). Read these before making structural changes.

## Permissions

| Permission | Required For | API |
|------------|-------------|-----|
| Screen Recording | Screen capture on Draw/Zoom mode entry | `CGPreflightScreenCaptureAccess()` / `ScreenCaptureKit` |

Accessibility permission is **not needed** (Carbon hotkey API).

## Testing

Tests cover `Models/`, `Draw/` renderers, and `ZoomMath`. Run with `xcodebuild test`. UI/overlay classes are not unit-tested (require a running app context).
