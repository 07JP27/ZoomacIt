##　Draw機能 詳細仕様

### A. Draw モードの操作体系（ZoomIt完全互換）

#### 重要な設計思想：「モード切替」ではなく「修飾キー押しっぱなし」

ZoomItのシェイプ切替は **ツールバーや状態切替ではない**。  
マウスドラッグ中に修飾キーを押している間だけ形状が変わる。  
これはキーから手を離せばすぐフリーハンドに戻るということを意味する。

```
[ マウスドラッグ中 ]
  修飾キーなし       → フリーハンド（ペン）
  Shift 押しっぱなし → 直線
  ⌘/Ctrl 押しっぱなし → 長方形
  Tab 押しっぱなし  → 楕円
  Shift + ⌘/Ctrl    → 矢印（始点が矢印の先端）
```

> **Macの注意点:** Windowsの`Ctrl`をそのまま`⌘（Command）`にマッピングするか`⌃（Control）`にするか要検討。  
> `⌘`はmacOSシステムショートカットと競合しやすいため`⌃`が無難。ただしZoomIt互換を優先するなら設定で両対応。

#### シェイプ描画の挙動詳細

| シェイプ | 修飾キー | 描画の起点/終点 |
|---|---|---|
| フリーハンド | なし | マウス軌跡そのまま |
| 直線 | Shift | ドラッグ開始点 → 現在点 |
| 長方形 | ⌃ (Ctrl) | ドラッグ開始点を頂点とするバウンディングボックス |
| 楕円 | Tab | ドラッグ開始点を頂点とするバウンディングボックスに内接 |
| 矢印 | Shift + ⌃ | **開始点が矢印の先端**（終点が尾）← ZoomIt独自仕様、要注意 |

---

### B. 色の切替

描画中に以下のキーを押すと即座に色が変わる（ドラッグ中でも可）。

| キー | 色 |
|---|---|
| R | 赤（デフォルト） |
| G | 緑 |
| B | 青 |
| O | オレンジ |
| Y | 黄 |
| P | ピンク |

#### ハイライターへの切替

`Shift + 色キー` でハイライターモードになる。  
同じ色キーを Shift なしで押すと通常ペンに戻る。

---

### C. ペンサイズの変更

| 操作 | 効果 |
|---|---|
| ⌃ + スクロールホイール | ペン太さを増減 |
| ⌃ + ↑ / ↓ | ペン太さを増減（マウスホイールがない場合）|

---

### D. Undo / 消去

| キー | 効果 |
|---|---|
| ⌘Z | 直前のストロークを1本だけ取り消し（Undo） |
| E | 全描画を消去（モードは維持） |
| スペースバー | カーソルを画面中央に移動（描画内容は消えない）|

---

### E. スケッチパッドモード（背景色変更）

| キー | 効果 |
|---|---|
| W | 画面全体を**白**で塗りつぶし（ホワイトボード） |
| K | 画面全体を**黒**で塗りつぶし（ブラックボード） |

`W` / `K` の実装:  
→ 透明オーバーレイの`backgroundColor`を変更するのではなく、  
　**白/黒の矩形をfinishedLayerの最下層に描いてキャッシュ**する。  
　そうしないと以降のストロークが背景色の上に正しく重ならない。

---

### F. テキストモード

| 操作 | 効果 |
|---|---|
| T キー | テキスト入力モードに入る |
| スクロールホイール / ↑↓ | フォントサイズ変更 |
| R/G/B/O/Y/P | テキスト色変更 |
| Escape | テキストを確定してペンモードに戻る |

テキスト確定時の処理:  
→ `NSTextView`の内容をoffscreen `CGBitmapContext`にレンダリングし、  
　`finishedLayer`にラスタライズして焼き込む。  
　以降はNSTextViewを破棄。

---

### G. Drawモードの出入り

| 操作 | 効果 |
|---|---|
| ホットキー（⌃2） | ネイティブ解像度でDrawモード開始 |
| ズーム中に左クリック | ズームしたままDrawモード開始 |
| Escape | Drawモード終了・オーバーレイ破棄 |
| 右クリック | Drawモード終了 |
| ⌘C | 現在の画面（描画込み）をクリップボードにコピー |
| ⌘S | 現在の画面（描画込み）をファイル保存 |

---

### H. イベントハンドリングの実装方針

```
mouseDown  → ストローク開始。開始点を記録。修飾キーの状態を確認。
mouseDragged → 
  ├ 修飾キーなし  : points配列に追加 → Catmull-Romでスムージング
  ├ Shift        : 開始点と現在点の直線をプレビュー（finishedLayerには触らない）
  ├ ⌃            : 開始点〜現在点のバウンディングボックスをプレビュー
  ├ Tab          : 同上で楕円プレビュー
  └ Shift+⌃     : 矢印プレビュー
mouseUp    → 確定。プレビューの形状をfinishedLayerにラスタライズ。

keyDown    →
  ├ R/G/B/O/Y/P  : activeColor更新
  ├ Shift+色キー : highlighterModeフラグON + activeColor更新
  ├ W/K          : 背景色レイヤーをfinishedLayerに書込み
  ├ T            : textModeに切替
  ├ E            : finishedLayer全消去
  └ Space        : カーソルを中央へ
```

#### シェイプのプレビュー実装

直線・長方形・楕円・矢印はドラッグ中に「プレビュー」を見せる必要がある。  
`mouseDragged`のたびにfinishedLayerを書き換えるのは重いため：

```
描画レイヤー構成:
  [ finishedLayer  (CGImage) ]   ← 確定済みストローク、変更しない
  [ previewLayer   (NSBezierPath) ]  ← ドラッグ中のシェイプのみ、mouseUpで破棄
  [ activeFreehand (NSBezierPath) ]  ← フリーハンドの現在のストローク
```

`draw(_:)`内で3層を順に描画し、`mouseUp`時に`previewLayer`を`finishedLayer`に焼き込む。